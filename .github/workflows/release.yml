name: Release CLIs

on:
  workflow_dispatch:
  push:
    branches:
      - main

concurrency: ${{ github.workflow }}-${{ github.ref }}

env:
  WORKSPACES: create-db create-pg create-postgres
  POSTHOG_API_HOST: ${{ secrets.POSTHOG_API_HOST }}
  POSTHOG_API_KEY: ${{ secrets.POSTHOG_API_KEY }}

jobs:
  release:
    name: ğŸš€ Release CLIs
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ›ï¸ Checkout Repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: ğŸ¤ Disable Husky
        run: echo "HUSKY=0" >> $GITHUB_ENV

      - name: ğŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8

      - name: ğŸ”§ Install dependencies
        run: pnpm install

      - name: âŒ Disable pnpm git-checks
        run: pnpm config set git-checks false

      - name: ğŸ”‘ Configure npm auth
        run: echo "//registry.npmjs.org/:_authToken=${{ secrets.CREATE_DB_TOKEN_NPM }}" > ~/.npmrc

      # Publish each CLI package using the version in package.json
      - name: ğŸš€ Publish Each CLI Package
        run: |
          echo "Using CREATE_DB_WORKER_URL=${CREATE_DB_WORKER_URL}"
          echo "Using CLAIM_DB_WORKER_URL=${CLAIM_DB_WORKER_URL}"
          echo "Using POSTHOG_API_HOST=${POSTHOG_API_HOST}"

          # First, publish create-db
          echo "Publishing create-db to npm..."
          cd create-db
          export POSTHOG_API_HOST="${{ secrets.POSTHOG_API_HOST }}"
          export POSTHOG_API_KEY="${{ secrets.POSTHOG_API_KEY }}"
          CREATE_DB_VERSION=$(node -p "require('./package.json').version")
          if ! pnpm publish --access public --no-git-checks; then
            echo "Publish failed, trying to bump version and retry..."
            npm version patch --no-git-tag-version
            CREATE_DB_VERSION=$(node -p "require('./package.json').version")
            pnpm publish --access public --no-git-checks || echo "Publish failed again for create-db"
          fi
          cd ..
          
          # Then publish create-pg and create-postgres with resolved dependencies
          for pkg in create-pg create-postgres; do
            echo "Publishing $pkg to npm..."
            cd "$pkg"
            export POSTHOG_API_HOST="${{ secrets.POSTHOG_API_HOST }}"
            export POSTHOG_API_KEY="${{ secrets.POSTHOG_API_KEY }}"
            
            # Update dependency to use the published version instead of workspace:*
            npm pkg set dependencies.create-db="$CREATE_DB_VERSION"
            
            if ! pnpm publish --access public --no-git-checks; then
              echo "Publish failed, trying to bump version and retry..."
              npm version patch --no-git-tag-version
              pnpm publish --access public --no-git-checks || echo "Publish failed again for $pkg"
            fi
            cd - >/dev/null
          done
        env:
          NODE_AUTH_TOKEN: ${{ secrets.CREATE_DB_TOKEN_NPM }}
          CREATE_DB_WORKER_URL: ${{ secrets.CREATE_DB_WORKER_URL }}
          CLAIM_DB_WORKER_URL: ${{ secrets.CLAIM_DB_WORKER_URL }}
          POSTHOG_API_HOST: ${{ secrets.POSTHOG_API_HOST }}
          POSTHOG_API_KEY: ${{ secrets.POSTHOG_API_KEY }}

      - name: ğŸ§¹ Cleanup npm auth
        run: rm -f ~/.npmrc

      # Create a default changeset if none exist
      - name: ğŸ“ Ensure Changeset Exists
        run: |
          if [ -z "$(ls -A .changeset 2>/dev/null)" ]; then
            echo "No changeset found. Creating a default one..."
            pnpm changeset add --empty --message "chore(release): auto-generated changeset"
          fi

      # Finally, create a PR for version bump + changelogs
      - name: ğŸ“ Prepare Changesets PR
        id: changesets
        uses: changesets/action@v1
        with:
          version: pnpm changeset version
          commit: "chore(release): version packages"
          title: "chore(release): version packages"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
