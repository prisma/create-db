# .github/workflows/release.yml
name: Release CLIs & Deploy CF Workers

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize]
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:

env:
  WORKSPACES: create-db create-pg create-postgres
  HUSKY: 0

jobs:
  #========================================================================
  # 1ï¸âƒ£ Dry-run each CLI on PRs
  #========================================================================
  dry-run:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ›ï¸ Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: ğŸ“¦ Setup pnpm v8
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: ğŸ”§ Install dependencies
        run: pnpm install --workspace-root

      - name: ğŸ“„ Copy root README into each CLI
        run: |
          for pkg in $WORKSPACES; do
            cp README.md "$pkg/README.md"
          done

      - name: ğŸš¨ Dry-run publish each CLI
        run: |
          set -e
          for pkg in $WORKSPACES; do
            echo "â³ Dry-running $pkg..."
            cd "$pkg"
            npm publish --dry-run
            cd -
          done

  #========================================================================
  # 2ï¸âƒ£ Real publish on tag pushes
  #========================================================================
  release:
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    needs: dry-run
    steps:
      - name: ğŸ›ï¸ Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: ğŸ“¦ Setup pnpm v8
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: ğŸ”§ Install dependencies (strict lockfile)
        run: pnpm install --workspace-root --frozen-lockfile

      - name: ğŸ”§ Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: ğŸ“„ Copy root README into each CLI
        run: |
          for pkg in $WORKSPACES; do
            cp README.md "$pkg/README.md"
          done

      - name: ğŸ”‘ Configure npm auth
        run: echo "//registry.npmjs.org/:_authToken=${{ secrets.CREATE_DB_TOKEN_NPM }}" > ~/.npmrc

      - name: ğŸš€ Publish each CLI sequentially
        run: |
          set -e
          TAG="${GITHUB_REF#refs/tags/}"
          for pkg in $WORKSPACES; do
            echo "â³ Publishing $pkg@$TAGâ€¦"
            cd "$pkg"
            npm publish --access public
            cd -
          done

      - name: ğŸš© Create GitHub Release
        uses: actions/create-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          release_name: Release ${{ github.ref_name }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ§¹ Cleanup npm auth
        if: ${{ always() }}
        run: rm -f ~/.npmrc
